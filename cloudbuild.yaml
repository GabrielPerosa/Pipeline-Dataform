steps:
  # Passo 1: Clonar o repositório de produção no Dataform
  - name: 'gcr.io/cloud-builders/git'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "Clonando o repositório do Dataform..."
        git clone https://github.com/GabrielPerosa/Pipeline-Dataform.git || { echo "Falha ao clonar o repositório"; exit 1; }
        cd Pipeline-Dataform/
        echo "Buscando a branch workspace-dataform-teste..."
        git fetch origin workspace-dataform-teste || { echo "Falha ao buscar a branch workspace-dataform-teste"; exit 1; }
        git checkout workspace-dataform-teste || { echo "Falha ao fazer checkout na branch workspace-dataform-teste"; exit 1; }

  # Passo 2: Instalar dependências do SQLFluff
  - name: 'python:3.9'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "Instalando dependências do SQLFluff..."
        pip install --no-cache-dir sqlfluff

  # Passo 3: Verificar qualidade dos arquivos SQL
  - name: 'python:3.9'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "Verificando qualidade dos arquivos SQL..."
        sqlfluff lint definitions/ > lint-results.txt
        if grep -q "L:  " lint-results.txt; then
          echo "Testes SQL falharam. Verifique os erros em lint-results.txt."
          exit 1
        else
          echo "Testes SQL passaram."
        fi

  # Passo 4: Clonar o repositório de produção e extrair a branch correta

  # Passo 5: Recuperar credenciais do Secret Manager
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "Recuperando credenciais do Secret Manager..."
        gcloud secrets versions access latest --secret=dataform-credentials > /workspace/.df-credentials.json
        echo "Credenciais salvas em /workspace/.df-credentials.json"

  # Passo 6: Verificar se o arquivo de credenciais foi recuperado
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "Verificando se o arquivo de credenciais foi recuperado..."
        if [ -f "/workspace/.df-credentials.json" ]; then
          echo "Arquivo de credenciais encontrado."
        else
          echo "Erro: Arquivo de credenciais não encontrado."
          exit 1
        fi

  # Passo 7: Instalar Node.js, npm, Dataform e executar
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "Instalando Node.js e npm..."
        curl -sL https://deb.nodesource.com/setup_16.x | bash -
        apt-get install -y nodejs
        echo "Instalando o Dataform..."
        npm install -g @dataform/cli
        echo "Autenticando com as credenciais..."
        gcloud auth activate-service-account --key-file=/workspace/.df-credentials.json
        echo "Executando Dataform..."
        dataform push || { echo "Falha ao executar o Dataform"; exit 1; }

substitutions:
  _AUTHOR_EMAIL: 'gabrielperosa493@gmail.com'

timeout: '1200s'

options:
  logging: CLOUD_LOGGING_ONLY
