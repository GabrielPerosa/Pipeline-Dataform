steps:
# Passo 1: Clonar o repositório (caso necessário)
- name: 'gcr.io/cloud-builders/git'
  args: ['clone', 'https://github.com/GabrielPerosa/Pipeline-Dataform.git']

# Passo 2: Instalar dependências do SQLFluff
- name: 'python:3.9'
  entrypoint: 'bash'
  script: |
    pip install --no-cache-dir sqlfluff

# Passo 3: Verificar qualidade dos scripts SQL
- name: 'python:3.9'
  entrypoint: 'bash'
  script: |
    # Identificar o email do autor do commit
    COMMIT_AUTHOR_EMAIL=$(git log -1 --pretty=format:'%ae')
    # Executar o lint
    sqlfluff lint definitions/ > lint-results.txt
    # Verificar o resultado do lint
    if grep -q "L:  " lint-results.txt; then
      echo "Testes SQL falharam. Notificando erro por email."
      echo "SQL Quality Check Failed. Review the errors in lint-results.txt." | mail -s "SQL Lint Failure" $COMMIT_AUTHOR_EMAIL
      exit 1
    else
      echo "SQL Quality Check Passed."
    fi

# Passo 4: Mesclar na branch main caso os testes passem
- name: 'gcr.io/cloud-builders/git'
  entrypoint: 'bash'
  script: |
    git checkout main
    git merge workspace-dataform-teste
    git push origin main

# Passo 5: Enviar scripts para o Dataform
- name: 'gcr.io/cloud-builders/gcloud'
  args: [
    'dataform', 'install',
    '--repository="repositorio-dataform"',
    '--workspace="workspace-dataform"',
    '--location="us-central1"'
  ]

substitutions:
  _COMMIT_AUTHOR_EMAIL: 'default@example.com'

timeout: '1200s'
