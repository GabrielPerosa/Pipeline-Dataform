steps:
  # Passo 1: Autenticação
  - name: 'gcr.io/cloud-builders/gcloud'
  - entrypoint: 'bash'
  - args:
    - '-c' 
    - |
      gcloud secrets versions access latest --secret="pfs-risco-tivea-key" > my-secret.json
      gcloud auth activate-service-account --key-file=my-secret.json
      export my-secret=my-secret.json
      gcloud auth list 

  # Passo 2: Rodar os testes SQLFluff e Enviar para Dataform
  - name: 'python:latest'
    id: 'Usando Python para validar SQL e enviar para o dataform'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        pip install sqlfluff
        sqlfluff lint .

        # Roda o dataform.py
        cd dataform/
        pip install -r requirements.txt
        python dataform.py

options:
  logging: CLOUD_LOGGING_ONLY  # Especifica que os logs serão enviados para o Cloud Logging