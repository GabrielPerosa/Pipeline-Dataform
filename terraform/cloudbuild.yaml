steps:
  - id: 'load env'
    name: 'google/cloud-sdk'
    entrypoint: 'sh'
    args:
      - '-c'
      - |
        echo "Instalando dependências..."
        pip install -r requirements.txt
        cd terraform
        python variables.py
        echo "Variáveis carregadas."

  - id: 'git config'
    name: 'alpine/git'
    entrypoint: 'sh'
    args:
      - '-c'
      - |
        echo "Configurando credenciais do Git..."
        git config --global user.name "$_GIT_USER_NAME"
        git config --global user.email "$_GIT_USER_EMAIL"

  - id: 'check commits'
    name: 'alpine/git'
    entrypoint: 'sh'
    args:
      - '-c'
      - |
        echo "Verificando novos commits na branch $_FEATURE_NAME..."
        git checkout $_FEATURE_NAME
        git pull origin $_FEATURE_NAME
        if [ "$(git log origin/$_BRANCH_NAME..HEAD --oneline)" = "" ]; then
          echo "Nenhum novo commit encontrado na branch $_FEATURE_NAME. Finalizando o pipeline."
          exit 0
        fi
        echo "Novos commits encontrados na branch $_FEATURE_NAME."

  - id: 'merge branch'
    name: 'alpine/git'
    entrypoint: 'sh'
    args:
      - '-c'
      - |
        echo "Fazendo checkout da branch $_FEATURE_NAME..."
        git checkout $_FEATURE_NAME
        git pull
        echo "Fazendo merge da branch $_FEATURE_NAME na $_BRANCH_NAME..."
        git checkout $_BRANCH_NAME
        git pull
        git merge $_FEATURE_NAME
        echo "Push das mudanças para a branch $_BRANCH_NAME..."
        git push

  - id: 'dataform update'
    name: 'gcr.io/your-project-id/dataform-cli'
    entrypoint: 'sh'
    args:
      - '-c'
      - |
        echo "Atualizando Dataform no GCP..."
        dataform run --project-dir /workspace/Pipeline-Dataform
        echo "Dataform atualizado com sucesso."
        echo "Tudo pronto."

substitutions:
  _BRANCH_NAME: 'feature/testes'
  _FEATURE_NAME: 'feature/testes-base'
  _GIT_USER_NAME: 'GabrielPerosa'
  _GIT_USER_EMAIL: 'gabrielperosa493@gmail.com'

secrets:
  - secretEnv:
      GIT_TOKEN: projects/95663131429/secrets/token-git/versions/latest

options:
  logging: CLOUD_LOGGING_ONLY